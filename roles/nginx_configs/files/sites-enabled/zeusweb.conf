server {
    listen 80 default; ## listen for ipv4
    listen 443 ssl;

    ssl_certificate ssl/zeus_ugent_be.pem;
    ssl_certificate_key ssl/zeus_ugent_be.key;
    ssl_session_timeout 5m;

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'AES128+EECDH:AES128+EDH:!aNULL';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.4.4 8.8.8.8 valid=300s;
    resolver_timeout 10s;

    add_header Strict-Transport-Security max-age=63072000;
    add_header X-Frame-Options DENY;
   # add_header X-Content-Type-Options nosniff;

    access_log /home/zeusweb/log/access.log;
    error_log /home/zeusweb/log/error.log notice;

    # Webcam
    rewrite ^/webcam(.*)$ http://kelder.zeus.ugent.be/webcam$1;

    # IRCAnywhere
    rewrite ^/irc(.*)$ http://kelder.zeus.ugent.be/irc$1;

    # User websites
    rewrite ^/~(.*)$ http://kelder.zeus.ugent.be/~$1;

    location /wiki {
        alias /usr/share/mediawiki;
        index index.php;
        # =404 to redirect errors to 404
        try_files $uri $uri/ @mediawiki =404;

        location ~ \.php5?$ {
            include /etc/nginx/fastcgi_params;
            fastcgi_pass unix:/var/run/php5-fpm/mediawiki.socket;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }

        access_log /usr/share/mediawiki/log/access.log;
        error_log /usr/share/mediawiki/log/error.log;
    }
    location @mediawiki {
        #rewrite ^.*/([^/]*)$ /index.php?title=$1&$args;
        rewrite ^/(.*)$ /index.php?title=$1&$args;
    }

    location @gitlabhq {
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    Host                $http_host;
        proxy_pass http://unix:/var/run/unicorn/gitlabhq.sock;
    }


    location /errbit {
        rewrite ^ http://errbit.nudded.be/;
    }

    location ~ ^/hydra/?$ {
        rewrite ^ http://github.com/ZeusWPI/hydra permanent;
    }

    location /hydra {
        alias /home/hydra/public;
        autoindex on;
    }

    location /blok {
        alias /home/bloklocaties/Bloklocaties/;
        index map.html index.html;

        access_log /home/bloklocaties/log/access.log;
        error_log /home/bloklocaties/log/error.log;
    }

    location ~ ^/game(/.*|$) {
        alias /home/gamification/production/current/public$1;
        passenger_base_uri /game;
        passenger_app_root /home/gamification/production/current;
        passenger_document_root /home/gamification/production/current/public;
        passenger_enabled on;

        access_log /home/gamification/log/access.log;
        error_log /home/gamification/log/error.log;
    }

    location ~ ^/quotes(/.*|$) {
        alias /home/zeusquotes/production/current/public$1;
        passenger_base_uri /quotes;
        passenger_app_root /home/zeusquotes/production/current;
        passenger_document_root /home/zeusquotes/production/current/public;
        passenger_enabled on;

        access_log /home/zeusquotes/log/access.log;
        error_log /home/zeusquotes/log/error.log;
    }

    location ~ ^/tab(/.*|$) {
        alias /home/tab/production/current/public$1;
        passenger_base_uri /tab;
        passenger_app_root /home/tab/production/current;
        passenger_document_root /home/tab/production/current/public;
        passenger_enabled on;

        access_log /home/tab/log/access.log;
        error_log /home/tab/log/error.log;
    }

    location / {
        # clean urls for wordpress
        try_files $uri/ $uri /index.php?q=$uri&$args =404;

        location ~ \.php$ {
            fastcgi_pass    unix:/var/run/php5-fpm.sock;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    location /phpadmin {
        alias /usr/share/phpmyadmin/;
        try_files $uri/ $uri index.php;
        

        location ~ \.php5?$ {
            include /etc/nginx/fastcgi_params;
            fastcgi_pass   unix:/var/run/php5-fpm.sock;
            fastcgi_param  SCRIPT_FILENAME  $request_filename;
        }
    }


    location /mail {
        alias /var/lib/roundcube;

        location ~ \.php$ {
            root /var/lib/roundcube;
            rewrite ^/mail(.*)$ $1 break;

            fastcgi_pass    unix:/var/run/php5-fpm.sock;
            fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
    }

    location /mail/program/js/tiny_mce/ {
        alias /usr/share/tinymce/www/;
    }

    location /icons {
        alias /usr/share/apache2/icons/;
    }

    # nginx monitoring
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }

    rewrite_log on;
}

